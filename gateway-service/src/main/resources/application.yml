server:
  port: 8090

spring:
  application:
    name: gateway-service
  
  cloud:
    gateway:
      # Configuración global
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
      
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowedHeaders: "*"
            exposedHeaders:
              - Authorization
              - Content-Disposition
            maxAge: 3600
      
      # ============================================================
      # RUTAS A LOS MICROSERVICIOS
      # Patrón: /api/[ruta]/** → StripPrefix=1 → /[ruta]/**
      # ============================================================
      routes:
        
        # ===========================================================
        # AUTH SERVICE (Puerto 8080)
        # Controlador: @RequestMapping("/auth")
        # ===========================================================
        - id: auth-service
          uri: ${AUTH_SERVICE_URL:http://localhost:8080}
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1
          # POST /api/auth/login → /auth/login
          # POST /api/auth/refresh → /auth/refresh
          # POST /api/auth/logout → /auth/logout
          # GET  /api/auth/me → /auth/me

        # ===========================================================
        # USER SERVICE (Puerto 8081)
        # Controlador: @RequestMapping("/usuarios")
        # ===========================================================
        - id: user-service
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/usuarios/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # INVENTORY SERVICE (Puerto 8082)
        # Controladores: /lotes, /tandas
        # ===========================================================
        - id: inventory-lotes
          uri: ${INVENTORY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/lotes/**
          filters:
            - StripPrefix=1

        - id: inventory-tandas
          uri: ${INVENTORY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/tandas/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # SALES SERVICE (Puerto 8083)
        # Controlador: @RequestMapping("/ventas")
        # ===========================================================
        - id: sales-service
          uri: ${SALES_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/ventas/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # BILLING SERVICE (Puerto 8084)
        # Controlador: @RequestMapping("/cuadres")
        # ===========================================================
        - id: billing-service
          uri: ${BILLING_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/cuadres/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # FINANCE SERVICE (Puerto 8085)
        # Controladores: /costos/produccion, /costos/configuracion, /fondo
        # ===========================================================
        - id: finance-costos
          uri: ${FINANCE_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/costos/**
          filters:
            - StripPrefix=1

        - id: finance-fondo
          uri: ${FINANCE_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/fondo/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # EQUIPMENT SERVICE (Puerto 8086)
        # Controladores: /equipos, /mensualidades
        # ===========================================================
        - id: equipment-equipos
          uri: ${EQUIPMENT_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/equipos/**
          filters:
            - StripPrefix=1

        - id: equipment-mensualidades
          uri: ${EQUIPMENT_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/mensualidades/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # DOCUMENT SERVICE (Puerto 8087)
        # Controlador: @RequestMapping("/documentos")
        # ===========================================================
        - id: document-service
          uri: ${DOCUMENT_SERVICE_URL:http://localhost:8087}
          predicates:
            - Path=/api/documentos/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # NOTIFICATION SERVICE (Puerto 8088)
        # Controlador: @RequestMapping("/notificaciones")
        # ===========================================================
        - id: notification-service
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8088}
          predicates:
            - Path=/api/notificaciones/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # BACKUP SERVICE (Puerto 8089)
        # Controlador: @RequestMapping("/backups")
        # ===========================================================
        - id: backup-service
          uri: ${BACKUP_SERVICE_URL:http://localhost:8089}
          predicates:
            - Path=/api/backups/**
          filters:
            - StripPrefix=1

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    gateway:
      enabled: true

# Logging
logging:
  level:
    org.springframework.cloud.gateway: INFO
    com.trabix: DEBUG