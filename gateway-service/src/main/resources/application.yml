server:
  port: 8090

spring:
  application:
    name: gateway-service
  
  cloud:
    gateway:
      # Configuración global
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
      
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowedHeaders: "*"
            exposedHeaders:
              - Authorization
              - Content-Disposition
            maxAge: 3600
      
      # ============================================================
      # RUTAS A LOS MICROSERVICIOS
      # Patrón: /api/[ruta]/** → StripPrefix=1 → /[ruta]/**
      # ============================================================
      routes:
        
        # ===========================================================
        # AUTH SERVICE (Puerto 8080)
        # Controlador: @RequestMapping("/auth")
        # ===========================================================
        - id: auth-service
          uri: ${AUTH_SERVICE_URL:http://localhost:8080}
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1
          # POST /api/auth/login → /auth/login
          # POST /api/auth/refresh → /auth/refresh
          # POST /api/auth/logout → /auth/logout
          # GET  /api/auth/me → /auth/me

        # ===========================================================
        # USER SERVICE (Puerto 8081)
        # Controlador: @RequestMapping("/usuarios")
        # ===========================================================
        - id: user-service
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/usuarios/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # INVENTORY SERVICE (Puerto 8082)
        # Controladores: /lotes, /tandas, /stock-produccion
        # ===========================================================
        - id: inventory-lotes
          uri: ${INVENTORY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/lotes/**
          filters:
            - StripPrefix=1

        - id: inventory-tandas
          uri: ${INVENTORY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/tandas/**
          filters:
            - StripPrefix=1

        - id: inventory-stock-produccion
          uri: ${INVENTORY_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/stock-produccion/**
          filters:
            - StripPrefix=1
          # GET  /api/stock-produccion → /stock-produccion
          # POST /api/stock-produccion/produccion → registrar producción
          # POST /api/stock-produccion/venta-directa → registrar venta directa
          # POST /api/stock-produccion/ajuste → ajuste manual
          # GET  /api/stock-produccion/movimientos → historial

        # ===========================================================
        # SALES SERVICE (Puerto 8083)
        # Controlador: @RequestMapping("/ventas")
        # ===========================================================
        - id: sales-service
          uri: ${SALES_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/ventas/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # BILLING SERVICE (Puerto 8084)
        # Controlador: @RequestMapping("/cuadres")
        # ===========================================================
        - id: billing-service
          uri: ${BILLING_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/cuadres/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # FINANCE SERVICE (Puerto 8085)
        # Controladores: /costos/produccion, /costos/configuracion, /fondo
        # ===========================================================
        - id: finance-costos
          uri: ${FINANCE_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/costos/**
          filters:
            - StripPrefix=1

        - id: finance-fondo
          uri: ${FINANCE_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/fondo/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # EQUIPMENT SERVICE (Puerto 8086)
        # Controladores: /asignaciones, /mensualidades, /stock
        # 
        # MODELO: Kit = Nevera + Pijama (siempre juntos)
        # ===========================================================
        - id: equipment-asignaciones
          uri: ${EQUIPMENT_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/asignaciones/**
          filters:
            - StripPrefix=1
          # POST /api/asignaciones → Asignar kit a vendedor
          # GET  /api/asignaciones → Listar todas (admin)
          # GET  /api/asignaciones/me → Mis asignaciones
          # GET  /api/asignaciones/me/activa → Mi asignación activa
          # GET  /api/asignaciones/me/bloqueado → ¿Estoy bloqueado?
          # POST /api/asignaciones/{id}/devolver → Devolver kit
          # POST /api/asignaciones/{id}/cancelar → Cancelar por pérdida/daño

        - id: equipment-mensualidades
          uri: ${EQUIPMENT_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/mensualidades/**
          filters:
            - StripPrefix=1
          # GET  /api/mensualidades/me/pendientes → Mis pagos pendientes
          # GET  /api/mensualidades/me/vencidos → Mis pagos vencidos
          # POST /api/mensualidades/{id}/pagar → Registrar pago (admin)
          # POST /api/mensualidades/generar → Generar mensualidades (admin)

        - id: equipment-stock
          uri: ${EQUIPMENT_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/stock/**
          filters:
            - StripPrefix=1
          # GET  /api/stock → Ver stock de kits (admin)
          # GET  /api/stock/disponibles → Cantidad disponible
          # POST /api/stock/agregar → Agregar kits nuevos (admin)

        # ===========================================================
        # DOCUMENT SERVICE (Puerto 8087)
        # Controlador: @RequestMapping("/documentos")
        # ===========================================================
        - id: document-service
          uri: ${DOCUMENT_SERVICE_URL:http://localhost:8087}
          predicates:
            - Path=/api/documentos/**
          filters:
            - StripPrefix=1

        # ===========================================================
        # NOTIFICATION SERVICE (Puerto 8088)
        # Controlador: @RequestMapping("/notificaciones")
        # ===========================================================
        - id: notification-service
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8088}
          predicates:
            - Path=/api/notificaciones/**
          filters:
            - StripPrefix=1
          # GET  /api/notificaciones/me → Mis notificaciones
          # GET  /api/notificaciones/me/contador → Contador no leídas
          # POST /api/notificaciones/me/marcar-todas-leidas → Marcar todas
          # POST /api/notificaciones → Crear notificación (admin)
          # POST /api/notificaciones/broadcast → Broadcast a todos (admin)

        # ===========================================================
        # BACKUP SERVICE (Puerto 8089)
        # Controlador: @RequestMapping("/backups")
        # Solo ADMIN
        # ===========================================================
        - id: backup-service
          uri: ${BACKUP_SERVICE_URL:http://localhost:8089}
          predicates:
            - Path=/api/backups/**
          filters:
            - StripPrefix=1
          # POST /api/backups → Crear backup
          # GET  /api/backups → Listar todos
          # GET  /api/backups/{id}/descargar → Descargar .zip
          # GET  /api/backups/resumen → Estadísticas

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: when-authorized

# Logging
logging:
  level:
    org.springframework.cloud.gateway: INFO
    com.trabix: DEBUG
